;
; JXCT Soil Sensor v3.13.0 - Professional IoT Solution
; Author: JXCT Development Team  
; Version: 3.13.0
; Last Updated: July 2025
; License: MIT
;

; Default environment for development
[platformio]
default_envs = esp32dev

; =============================================================================
; üõ†Ô∏è DEVELOPMENT CONFIGURATION - –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏
; =============================================================================
[env:esp32dev]
platform = espressif32 @ ^6.3.0
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.partitions = min_spiffs.csv
test_build_src = yes
monitor_encoding = utf-8

; Project metadata and development flags
build_flags = 
  -D JXCT_BUILD_DATE='"2025-06-11"'
  -D MQTT_MAX_PACKET_SIZE=1024
  -D MQTT_KEEPALIVE=60
  -D MQTT_SOCKET_TIMEOUT=15
  -D LED_BUILTIN=2
  -D BOOT_BUTTON=0
  -D DEBUG_MODE         ; –û—Ç–ª–∞–¥–æ—á–Ω—ã–π —Ä–µ–∂–∏–º
  -D INFO_MODE          ; –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  ; –ë–∞–∑–æ–≤—ã–µ FreeRTOS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
  -D ARDUINO_LOOP_STACK_SIZE=6144  ; –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  -D CONFIG_FREERTOS_HZ=1000       ; –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å —Ç–∞–π–º–∏–Ω–≥–∞
  -std=gnu++17
  -fstack-protector-all
  -D CONFIG_HEAP_POISONING_LIGHT=1
  -D CONFIG_STACK_CHECK_MODE=2

; Core libraries
lib_deps =
  knolleary/PubSubClient @ ^2.8
  bblanchon/ArduinoJson @ ^6.21.4
  4-20ma/ModbusMaster @ ^2.0.1
  arduino-libraries/NTPClient @ ^3.2.1
  mathworks/ThingSpeak @ ^2.1.1

; Debugging tools
monitor_filters = colorize, esp32_exception_decoder

; –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç C++11, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è C++17
build_unflags =
  -std=gnu++11

; –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ 240 –ú–ì—Ü
board_build.f_cpu = 240000000L

extra_scripts = pre:scripts/auto_version.py

; =============================================================================
; üè≠ PRODUCTION CONFIGURATION - –°—Ç–∞–±–∏–ª—å–Ω–∞—è production –≤–µ—Ä—Å–∏—è
; =============================================================================
[env:esp32dev-production]
extends = env:esp32dev
build_type = release
build_flags = 
  -D JXCT_BUILD_DATE='"2025-06-11"'
  -D MQTT_MAX_PACKET_SIZE=1024
  -D MQTT_KEEPALIVE=60
  -D MQTT_SOCKET_TIMEOUT=15
  -D LED_BUILTIN=2
  -D BOOT_BUTTON=0
  -D NDEBUG
  
  ; ‚ö° –§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ v3.10.0 - –ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø
  -Os                    ; –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ (–≤–º–µ—Å—Ç–æ -O3)
  -ffast-math           ; –ë—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π
  -funroll-loops        ; –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Ü–∏–∫–ª–æ–≤
  -fomit-frame-pointer  ; –£–±–∏—Ä–∞–µ–º frame pointer
  -finline-functions    ; –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –∏–Ω–ª–∞–π–Ω–∏–Ω–≥
  -ffunction-sections   ; –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
  -fdata-sections       ; –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  -fno-rtti             ; –û—Ç–∫–ª—é—á–∞–µ–º RTTI –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
  -fno-exceptions       ; –û—Ç–∫–ª—é—á–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
  -fno-threadsafe-statics ; –û—Ç–∫–ª—é—á–∞–µ–º thread-safe statics
  -fno-use-cxa-atexit   ; –û—Ç–∫–ª—é—á–∞–µ–º atexit
  
  ; üîã –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ)
  -D CORE_DEBUG_LEVEL=0           ; –û—Ç–∫–ª—é—á–∞–µ–º debug Arduino Core
  -D CONFIG_ARDUHAL_LOG_COLORS=0  ; –û—Ç–∫–ª—é—á–∞–µ–º —Ü–≤–µ—Ç–∞ –≤ –ª–æ–≥–∞—Ö
  -D CONFIG_ARDUHAL_LOG_TIMESTAMP=0 ; –û—Ç–∫–ª—é—á–∞–µ–º timestamp –≤ –ª–æ–≥–∞—Ö
  
  ; üöÄ FreeRTOS –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–ë–ï–ó–û–ü–ê–°–ù–´–ï –¥–ª—è –Ω–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
  -D ARDUINO_LOOP_STACK_SIZE=8192                    ; –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—Ç–µ–∫ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  -D CONFIG_FREERTOS_HZ=1000                         ; –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å —Ç–∞–π–º–∏–Ω–≥–∞
  -D CONFIG_FREERTOS_VTASKLIST_INCLUDE_COREID=0      ; –û—Ç–∫–ª—é—á–∏—Ç—å Core ID 
  -D CONFIG_FREERTOS_GENERATE_RUN_TIME_STATS=0       ; –û—Ç–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  -D CONFIG_FREERTOS_CHECK_STACKOVERFLOW=2           ; –í–ö–õ–Æ–ß–ê–ï–ú –ø—Ä–æ–≤–µ—Ä–∫–∏ stack –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  -D CONFIG_FREERTOS_HEAP_TASK_TRACKING=0            ; –û—Ç–∫–ª—é—á–∏—Ç—å heap tracking
  -D CONFIG_FREERTOS_USE_TRACE_FACILITY=0            ; –û—Ç–∫–ª—é—á–∏—Ç—å trace facility
  -D CONFIG_FREERTOS_USE_STATS_FORMATTING_FUNCTIONS=0 ; –û—Ç–∫–ª—é—á–∏—Ç—å stats formatting
  -std=gnu++17
  -fstack-protector-all
  -D CONFIG_HEAP_POISONING_LIGHT=0                   ; –û–¢–ö–õ–Æ–ß–ê–ï–ú heap poisoning
  -D CONFIG_STACK_CHECK_MODE=0                       ; –û–¢–ö–õ–Æ–ß–ê–ï–ú stack checking
  -D NO_ANSI_COLORS
  -D NO_EMOJI

build_unflags = 
  -fno-exceptions       ; –£–±–∏—Ä–∞–µ–º overhead –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
  -std=gnu++11

; –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–ª–∞–≥–∏ –ª–∏–Ω–∫–µ—Ä–∞
board_build.ldflags = 
  -Wl,--gc-sections      ; –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–µ–∫—Ü–∏–π
  -Wl,-O2               ; –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–∏–Ω–∫–µ—Ä–∞
  -Wl,--relax           ; –õ–∏–Ω–∫–µ—Ä–Ω–∞—è —Ä–µ–ª–∞–∫—Å–∞—Ü–∏—è 
  -Wl,--strip-all       ; –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã

; –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
board_build.f_cpu = 240000000L

extra_scripts = pre:scripts/auto_version.py

monitor_encoding = utf-8

; =============================================================================
; üñ•Ô∏è NATIVE TEST CONFIGURATION - –ë—ã—Å—Ç—Ä—ã–µ unit-—Ç–µ—Å—Ç—ã –Ω–∞ —Ö–æ—Å—Ç–µ
; =============================================================================
[env:native]
platform = native
build_flags = -std=c++17 -I test/stubs -I include -DUNITY_INCLUDE_CONFIG_H
test_build_src = yes
build_src_filter = +<validation_utils.cpp> +<sensor_compensation.cpp> +<jxct_format_utils.cpp> +<csrf_protection.cpp> -<*>
lib_deps = 
  unity
test_filter = 
  test_simple_native
  test_performance

; =============================================================================
; üîç STATIC ANALYSIS CONFIGURATION - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
; =============================================================================
[env:static-analysis]
extends = env:esp32dev
check_tool = cppcheck
check_flags = 
  cppcheck: --enable=warning,style,performance,portability,unusedFunction
  cppcheck: --language=c++
  cppcheck: --std=c++17
  cppcheck: --platform=unspecified
  cppcheck: --error-exitcode=3
  cppcheck: --verbose
  cppcheck: --template="severity={severity}<&PIO&>message={message}<&PIO&>file={file}<&PIO&>line={line}<&PIO&>column={column}<&PIO&>callstack={callstack}<&PIO&>cwe={cwe}<&PIO&>id={id}"

; =============================================================================
; üß™ ESP32 TEST CONFIGURATION - –¢–µ—Å—Ç—ã –¥–ª—è ESP32
; =============================================================================
[env:esp32dev-test]
extends = env:esp32dev
test_build_src = yes
build_src_filter = 
  +<*>
  -<main.cpp>
test_filter = 
  test_simple
build_flags = 
  -D PIO_UNIT_TESTING
  -D UNITY_INCLUDE_CONFIG_H
  -D ARDUINO_LOOP_STACK_SIZE=8192
  -D ESP32
  -D ARDUINO_ARCH_ESP32
  -D ARDUINO_MAIN_DISABLED
  -D ARDUINO_LOOP_DISABLED
lib_deps =
  unity
  knolleary/PubSubClient @ ^2.8
  bblanchon/ArduinoJson @ ^6.21.4
  4-20ma/ModbusMaster @ ^2.0.1
  arduino-libraries/NTPClient @ ^3.2.1
  mathworks/ThingSpeak @ ^2.1.1

[test]
ignore = test_calibration_unity, test_all_combined 
; =============================================================================
; üîç ENHANCED STATIC ANALYSIS CONFIGURATION - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
; =============================================================================
[env:static-analysis-enhanced]
extends = env:esp32dev
check_tool = 
    clangtidy
    cppcheck
check_flags =
    clangtidy: >
        --checks=bugprone-*,misc-*,performance-*,clang-analyzer-*,
        modernize-use-trailing-return-type,
        readability-identifier-naming,
        -bugprone-easily-swappable-parameters,
        -readability-convert-member-functions-to-static
    cppcheck: >
        --enable=warning,style,performance,portability,unusedFunction
        --language=c++
        --std=c++17
        --platform=unspecified
        --error-exitcode=3
        --verbose

build_flags = 
    -D ESP32
    -D ARDUINO_ARCH_ESP32
    -D CONFIG_FREERTOS_HZ=1000
    -D ARDUINO_LOOP_STACK_SIZE=8192
    -std=gnu++17
    -fstack-protector-all
