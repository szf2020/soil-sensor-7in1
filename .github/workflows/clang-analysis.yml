name: Clang Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  clang-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio
          
      - name: Install Clang Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy clang-format clangd llvm-dev
          
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          
      - name: Run Enhanced Static Analysis
        run: |
          pio check -e static-analysis-enhanced
          
      - name: Run Clang-Tidy Analysis
        run: |
          python scripts/run_clang_tidy_analysis.py
          
      - name: Run Code Formatting Check
        run: |
          python scripts/format_code.py
          
      - name: Run Basic Tests
        run: |
          python scripts/run_simple_tests.py
          
      - name: Upload Analysis Results
        uses: actions/upload-artifact@v4
        with:
          name: clang-analysis-results
          path: |
            test_reports/
            .pio/build/static-analysis-enhanced/
          retention-days: 30
          
      - name: Comment PR with Analysis Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## ğŸ” Clang Analysis Results\n\n';
            
            // Check if clang-tidy report exists
            const tidyReportPath = 'test_reports/clang_tidy_analysis_report.md';
            if (fs.existsSync(tidyReportPath)) {
              const tidyReport = fs.readFileSync(tidyReportPath, 'utf8');
              const warningCount = tidyReport.match(/Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğ¹: (\d+)/);
              if (warningCount) {
                const count = parseInt(warningCount[1]);
                if (count > 0) {
                  comment += `âš ï¸ **Clang-Tidy Warnings:** ${count}\n`;
                  comment += `ğŸ“Š [View Full Report](${github.server_url}/${github.repository}/actions/runs/${github.run_id})\n\n`;
                } else {
                  comment += `âœ… **Clang-Tidy:** No warnings found\n\n`;
                }
              }
            }
            
            // Check if test report exists
            const testReportPath = 'test_reports/simple-test-report.json';
            if (fs.existsSync(testReportPath)) {
              const testReport = JSON.parse(fs.readFileSync(testReportPath, 'utf8'));
              if (testReport.status === 'PASS') {
                comment += `âœ… **Tests:** All tests passed\n\n`;
              } else {
                comment += `âŒ **Tests:** Some tests failed\n\n`;
              }
            }
            
            comment += `ğŸ”§ **Analysis completed successfully**\n`;
            comment += `ğŸ“ [Download Artifacts](${github.server_url}/${github.repository}/actions/runs/${github.run_id})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }); 