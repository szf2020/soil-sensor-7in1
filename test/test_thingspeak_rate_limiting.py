#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ ThingSpeak
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ 1 —á–∞—Å –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
"""

import sys

def test_thingspeak_rate_limiting_logic():
    """–¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã ThingSpeak"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã ThingSpeak")
    print("=" * 60)
    
    # –°–∏–º—É–ª—è—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    last_ts_publish = 0
    last_fail_time = 0
    consecutive_fail_count = 0
    
    # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    THINGSPEAK_INTERVAL = 600000  # 10 –º–∏–Ω—É—Ç
    RATE_LIMIT_DURATION = 3600000  # 1 —á–∞—Å
    MAX_FAIL_COUNT = 10
    
    def can_send_to_thingspeak(thing_speak_enabled, wifi_connected, sensor_valid, current_time):
        """–°–∏–º—É–ª—è—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ canSendToThingSpeak"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏–π
        if not thing_speak_enabled:
            return False
        if not wifi_connected:
            return False
        if not sensor_valid:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 1 —á–∞—Å –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
        if (consecutive_fail_count >= MAX_FAIL_COUNT and 
            (current_time - last_fail_time) < RATE_LIMIT_DURATION):
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ C++)
        return (current_time - last_ts_publish) >= THINGSPEAK_INTERVAL
    
    def simulate_send_attempt(success, current_time):
        """–°–∏–º—É–ª—è—Ü–∏—è –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏"""
        nonlocal last_ts_publish, last_fail_time, consecutive_fail_count
        
        if success:
            last_ts_publish = current_time
            consecutive_fail_count = 0
            return True
        else:
            consecutive_fail_count += 1
            last_fail_time = current_time
            
            # –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 1 —á–∞—Å
            if consecutive_fail_count >= MAX_FAIL_COUNT:
                pass  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
            
            return False
    
    # –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    print("1Ô∏è‚É£ –¢–µ—Å—Ç –±–∞–∑–æ–≤—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫...")
    assert not can_send_to_thingspeak(False, True, True, 600000), "ThingSpeak –æ—Ç–∫–ª—é—á–µ–Ω"
    assert not can_send_to_thingspeak(True, False, True, 600000), "WiFi –æ—Ç–∫–ª—é—á–µ–Ω"
    assert not can_send_to_thingspeak(True, True, False, 600000), "–î–∞–Ω–Ω—ã–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏ –≤—Å–µ—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞
    result = can_send_to_thingspeak(True, True, True, 600000)
    assert result, f"–í—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {result}"
    print("‚úÖ –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã")
    
    # –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
    print("2Ô∏è‚É£ –¢–µ—Å—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏...")
    
    # –ü–µ—Ä–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à—ë–ª –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–∞–∫ –≤ main.cpp)
    # –í –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ 0 –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–µ –ø—Ä–æ—à—ë–ª, –ø–æ—ç—Ç–æ–º—É –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞
    result = can_send_to_thingspeak(True, True, True, 0)
    assert not result, f"–í –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ 0 –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–µ –ø—Ä–æ—à—ë–ª, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {result}"
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ 600000 (—Ä–æ–≤–Ω–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª)
    simulate_send_attempt(True, 600000)
    
    # –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–∞
    current_time = 900000  # 15 –º–∏–Ω—É—Ç (5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏)
    result = can_send_to_thingspeak(True, True, True, current_time)
    assert not result, f"–ò–Ω—Ç–µ—Ä–≤–∞–ª –Ω–µ –∏—Å—Ç–µ–∫ (5 –º–∏–Ω < 10 –º–∏–Ω), –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {result}"
    
    current_time = 1300000  # 21.7 –º–∏–Ω—É—Ç (–±–æ–ª—å—à–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ 600000)
    result = can_send_to_thingspeak(True, True, True, current_time)
    assert result, f"–ò–Ω—Ç–µ—Ä–≤–∞–ª –∏—Å—Ç–µ–∫ (11.7 –º–∏–Ω > 10 –º–∏–Ω), –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {result}"
    print("‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω")
    
    # –¢–µ—Å—Ç 3: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
    print("3Ô∏è‚É£ –¢–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö...")
    # –°–∏–º—É–ª–∏—Ä—É–µ–º 10 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
    for i in range(10):
        simulate_send_attempt(False, current_time + i * 1000)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
    current_time = 1800000  # 30 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–∏
    assert not can_send_to_thingspeak(True, True, True, current_time), "–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞"
    print("‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç")
    
    # –¢–µ—Å—Ç 4: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –±–ª–æ–∫–∞–¥—ã
    print("4Ô∏è‚É£ –¢–µ—Å—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –±–ª–æ–∫–∞–¥—ã...")
    current_time = 7200000  # 2 —á–∞—Å–∞ (–±–æ–ª—å—à–µ —á–∞—Å–∞)
    result = can_send_to_thingspeak(True, True, True, current_time)
    assert result, f"–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∞, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {result}"
    print("‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –±–ª–æ–∫–∞–¥—ã —Ä–∞–±–æ—Ç–∞–µ—Ç")
    
    # –¢–µ—Å—Ç 5: –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    print("5Ô∏è‚É£ –¢–µ—Å—Ç —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ...")
    simulate_send_attempt(True, current_time)
    assert consecutive_fail_count == 0, "–°—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–±—Ä–æ—à–µ–Ω"
    print("‚úÖ –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
    
    # –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü
    print("6Ô∏è‚É£ –¢–µ—Å—Ç —Ç–æ—á–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü...")
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    consecutive_fail_count = 0
    last_fail_time = 0
    last_ts_publish = 0
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º 10 –æ—à–∏–±–æ–∫
    for i in range(10):
        simulate_send_attempt(False, i * 1000)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—É –≤ 1 —á–∞—Å
    current_time = 3599999  # 59 –º–∏–Ω—É—Ç 59 —Å–µ–∫—É–Ω–¥ 999 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
    assert not can_send_to_thingspeak(True, True, True, current_time), "–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞"
    
    current_time = 7200000  # 2 —á–∞—Å–∞ (–±–æ–ª—å—à–µ —á–∞—Å–∞)
    assert can_send_to_thingspeak(True, True, True, current_time), "–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∞"
    print("‚úÖ –¢–æ—á–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")
    
    print("=" * 60)
    print("üéâ –í–°–ï –¢–ï–°–¢–´ –õ–û–ì–ò–ö–ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ß–ê–°–¢–û–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
    return True

def test_thingspeak_error_handling():
    """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ ThingSpeak"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ ThingSpeak")
    print("=" * 60)
    
    def simulate_thingspeak_response(response_code):
        """–°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç ThingSpeak"""
        if response_code == 200:
            return "–£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞"
        elif response_code == -301:
            return "Timeout -301"
        elif response_code == -401:
            return "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π (15 —Å–µ–∫)"
        elif response_code == -302:
            return "–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á"
        elif response_code == -304:
            return "–ù–µ–≤–µ—Ä–Ω—ã–π Channel ID"
        elif response_code == 0:
            return "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
        elif response_code == 400:
            return "HTTP 400 ‚Äì –Ω–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (API/Channel)"
        else:
            return f"–û—à–∏–±–∫–∞ {response_code}"
    
    # –¢–µ—Å—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–¥–æ–≤ –æ—Ç–≤–µ—Ç–∞
    test_cases = [
        (200, "–£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞"),
        (-301, "Timeout -301"),
        (-401, "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π (15 —Å–µ–∫)"),
        (-302, "–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á"),
        (-304, "–ù–µ–≤–µ—Ä–Ω—ã–π Channel ID"),
        (0, "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"),
        (400, "HTTP 400 ‚Äì –Ω–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (API/Channel)"),
        (500, "–û—à–∏–±–∫–∞ 500")
    ]
    
    for response_code, expected_message in test_cases:
        result = simulate_thingspeak_response(response_code)
        assert result == expected_message, f"–û–∂–∏–¥–∞–ª–æ—Å—å '{expected_message}', –ø–æ–ª—É—á–µ–Ω–æ '{result}'"
        print(f"‚úÖ –ö–æ–¥ {response_code}: {result}")
    
    print("=" * 60)
    print("üéâ –í–°–ï –¢–ï–°–¢–´ –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
    return True

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    print("üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ThingSpeak")
    print("=" * 80)
    
    tests = [
        test_thingspeak_rate_limiting_logic,
        test_thingspeak_error_handling
    ]
    
    passed = 0
    total = len(tests)
    
    for test in tests:
        try:
            test()
            passed += 1
            print(f"‚úÖ {test.__name__}: PASS")
        except Exception as e:
            print(f"‚ùå {test.__name__}: FAIL - {e}")
        print()
    
    print("=" * 80)
    print(f"üìä –ò–¢–û–ì–û–í–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´: {passed}/{total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ")
    
    if passed == total:
        print("üéâ –í–°–ï –¢–ï–°–¢–´ THINGSPEAK –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
        print("‚úÖ –õ–æ–≥–∏–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
        print("‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ")
        print("‚úÖ –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫—Ç–∏–≤–Ω–∞")
        return 0
    else:
        print("‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏")
        return 1

if __name__ == "__main__":
    sys.exit(main()) 