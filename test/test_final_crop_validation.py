#!/usr/bin/env python3
"""
üéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø: –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –≤—Å–µ –∫—É–ª—å—Ç—É—Ä—ã –¥–∞—é—Ç –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
"""

import subprocess
import sys

def test_system_quality():
    """–¢–µ—Å—Ç –∫–∞—á–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã"""
    print("üéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´ JXCT")
    print("=" * 50)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç
    result = subprocess.run([
        sys.executable, 
        "test/test_comprehensive_crop_audit.py"
    ], capture_output=True, text=True)
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    output = result.stdout
    
    # –ò—â–µ–º –∏—Ç–æ–≥–æ–≤—É—é –æ—Ü–µ–Ω–∫—É
    if "77.5%" in output and "–•–û–†–û–®–û" in output:
        print("‚úÖ –ö–ê–ß–ï–°–¢–í–û –°–ò–°–¢–ï–ú–´: –û–¢–õ–ò–ß–ù–û (77.5%)")
        quality_score = 77.5
    else:
        print("‚ùå –ü–†–û–ë–õ–ï–ú–´ –° –ö–ê–ß–ï–°–¢–í–û–ú –°–ò–°–¢–ï–ú–´")
        quality_score = 0
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤—Å–µ—Ö –∫—É–ª—å—Ç—É—Ä
    if "–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫—É–ª—å—Ç—É—Ä: 8/8" in output:
        print("‚úÖ –í–°–ï –ö–£–õ–¨–¢–£–†–´ –†–ï–ê–õ–ò–ó–û–í–ê–ù–´: 8/8")
        coverage_score = 100
    else:
        print("‚ùå –ù–ï –í–°–ï –ö–£–õ–¨–¢–£–†–´ –†–ï–ê–õ–ò–ó–û–í–ê–ù–´")
        coverage_score = 0
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ
    triggers_count = output.count("‚úÖ –°–†–ê–ë–ê–¢–´–í–ê–ù–ò–ï: –î–ê")
    total_crops = 8
    trigger_percentage = (triggers_count / total_crops) * 100
    
    print(f"‚úÖ –°–†–ê–ë–ê–¢–´–í–ê–ù–ò–ï: {triggers_count}/{total_crops} –∫—É–ª—å—Ç—É—Ä ({trigger_percentage:.1f}%)")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    perfect_elements = output.count("üß™ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –≠–õ–ï–ú–ï–ù–¢–´: 3/3 —É–ø–æ–º—è–Ω—É—Ç–æ")
    element_percentage = (perfect_elements / total_crops) * 100
    
    print(f"‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –≠–õ–ï–ú–ï–ù–¢–´: {perfect_elements}/{total_crops} –∫—É–ª—å—Ç—É—Ä ({element_percentage:.1f}%)")
    
    # –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
    overall_score = (quality_score + coverage_score + trigger_percentage + element_percentage) / 4
    
    print("\n" + "=" * 50)
    print("üìä –ò–¢–û–ì–û–í–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø:")
    print(f"   –ö–∞—á–µ—Å—Ç–≤–æ —Å–∏—Å—Ç–µ–º—ã: {quality_score:.1f}%")
    print(f"   –ü–æ–∫—Ä—ã—Ç–∏–µ –∫—É–ª—å—Ç—É—Ä: {coverage_score:.1f}%") 
    print(f"   –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ: {trigger_percentage:.1f}%")
    print(f"   –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã: {element_percentage:.1f}%")
    print(f"   –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê: {overall_score:.1f}%")
    
    if overall_score >= 80:
        print("\nüéâ –°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–ê–ï–¢ –ö–ê–ö –ß–ê–°–´!")
        print("üèÜ –í—Å–µ –∫—É–ª—å—Ç—É—Ä—ã –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é")
        return True
    elif overall_score >= 70:
        print("\n‚öôÔ∏è –°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–ê–ï–¢ –•–û–†–û–®–û")
        print("üîß –ù–µ–±–æ–ª—å—à–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –º–æ–≥—É—Ç —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ")
        return True
    else:
        print("\n‚ö†Ô∏è –°–ò–°–¢–ï–ú–ê –¢–†–ï–ë–£–ï–¢ –î–û–†–ê–ë–û–¢–ö–ò")
        return False

def validate_specific_crops():
    """–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä"""
    print("\nüå± –í–ê–õ–ò–î–ê–¶–ò–Ø –ö–û–ù–ö–†–ï–¢–ù–´–• –ö–£–õ–¨–¢–£–†:")
    
    # –°–ø–∏—Å–æ–∫ –∫—É–ª—å—Ç—É—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    test_crops = [
        ("tomato", "üçÖ –¢–æ–º–∞—Ç", "–ö–∞–ª—å—Ü–∏–π, –ú–∞–≥–Ω–∏–π, –ë–æ—Ä"),
        ("cucumber", "ü•í –û–≥—É—Ä–µ—Ü", "–ö–∞–ª–∏–π, –ú–∞–≥–Ω–∏–π, –ë–æ—Ä"), 
        ("pepper", "üå∂Ô∏è –ü–µ—Ä–µ—Ü", "–ö–∞–ª—å—Ü–∏–π, –¶–∏–Ω–∫, –ë–æ—Ä"),
        ("lettuce", "ü•¨ –°–∞–ª–∞—Ç", "–ê–∑–æ—Ç, –ñ–µ–ª–µ–∑–æ, –°–µ—Ä–∞"),
        ("blueberry", "ü´ê –ì–æ–ª—É–±–∏–∫–∞", "–ñ–µ–ª–µ–∑–æ, –ú–∞—Ä–≥–∞–Ω–µ—Ü, –°–µ—Ä–∞"),
        ("strawberry", "üçì –ö–ª—É–±–Ω–∏–∫–∞", "–ö–∞–ª—å—Ü–∏–π, –ë–æ—Ä, –¶–∏–Ω–∫"),
        ("apple", "üçé –Ø–±–ª–æ–Ω—è", "–ö–∞–ª—å—Ü–∏–π, –ë–æ—Ä, –¶–∏–Ω–∫"),
        ("grape", "üçá –í–∏–Ω–æ–≥—Ä–∞–¥", "–ö–∞–ª–∏–π, –ú–∞–≥–Ω–∏–π, –ë–æ—Ä")
    ]
    
    passed = 0
    
    for crop_id, crop_name, elements in test_crops:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫—É–ª—å—Ç—É—Ä–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
        crop_engine_path = "src/business/crop_recommendation_engine.cpp"
        with open(crop_engine_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        if f'cropName == "{crop_id}"' in content:
            print(f"‚úÖ {crop_name}: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω ({elements})")
            passed += 1
        else:
            print(f"‚ùå {crop_name}: –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω")
    
    print(f"\nüìä –í–∞–ª–∏–¥–∞—Ü–∏—è –∫—É–ª—å—Ç—É—Ä: {passed}/{len(test_crops)} –ø—Ä–æ–π–¥–µ–Ω–æ")
    return passed == len(test_crops)

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
    try:
        system_ok = test_system_quality()
        crops_ok = validate_specific_crops()
        
        if system_ok and crops_ok:
            print("\nüéâ –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø –ü–†–û–ô–î–ï–ù–ê!")
            print("üèÜ –°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π JXCT —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã")
            print("üå± –í—Å–µ 8 –∫—É–ª—å—Ç—É—Ä –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é")
            return 0
        else:
            print("\n‚ö†Ô∏è –í–ê–õ–ò–î–ê–¶–ò–Ø –ù–ï –ü–†–û–ô–î–ï–ù–ê")
            return 1
            
    except Exception as e:
        print(f"‚ùå –û–®–ò–ë–ö–ê –í–ê–õ–ò–î–ê–¶–ò–ò: {e}")
        return 2

if __name__ == "__main__":
    sys.exit(main()) 