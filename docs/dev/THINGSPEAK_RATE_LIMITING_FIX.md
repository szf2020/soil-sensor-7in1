# ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº ThingSpeak

## ðŸš¨ ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°
ThingSpeak Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð» Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð¸Ð·-Ð·Ð° ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ñ‡Ð°ÑÑ‚Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹:
```
ThingSpeak: ÐžÑˆÐ¸Ð±ÐºÐ°: ÐžÑ‚ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° 1 Ñ‡Ð°Ñ (Ð¼Ð½Ð¾Ð³Ð¾ Ð¾ÑˆÐ¸Ð±Ð¾Ðº)
```

## ðŸ” ÐÐ½Ð°Ð»Ð¸Ð· Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹
1. **ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ**: Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð½Ðµ ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð»Ð° Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð½Ð° 1 Ñ‡Ð°Ñ Ð¿Ñ€Ð¸ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…
2. **Ð¡Ð¿Ð°Ð¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸**: ÐŸÑ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ… ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ð»Ð° Ð¿Ñ‹Ñ‚Ð°Ñ‚ÑŒÑÑ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±ÐµÐ· ÑƒÑ‡ÐµÑ‚Ð° Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹
3. **ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸**: ÐÐµÑ‚ Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ´ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¾Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸

## âœ… Ð ÐµÑˆÐµÐ½Ð¸Ðµ

### 1. Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñ‹
- **Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ `lastFailTime`**: ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÑ‚ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
- **ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð½Ð° 1 Ñ‡Ð°Ñ**: ÐŸÑ€Ð¸ 10+ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ… Ð¿Ð¾Ð´Ñ€ÑÐ´ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° Ð½Ð° 3600000 Ð¼Ñ (1 Ñ‡Ð°Ñ)
- **Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑ…Ð°**: ÐŸÑ€Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ ÑÐ±Ñ€Ð¾Ñ Ð²ÑÐµÑ… ÑÑ‡ÐµÑ‚Ñ‡Ð¸ÐºÐ¾Ð² Ð¾ÑˆÐ¸Ð±Ð¾Ðº

### 2. ÐÐ¾Ð²Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ `canSendToThingSpeak()`
```cpp
bool canSendToThingSpeak()
{
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹
    if (!config.flags.thingSpeakEnabled) return false;
    if (!wifiConnected) return false;
    if (!sensorData.valid) return false;

    const unsigned long now = millis();
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð½Ð° 1 Ñ‡Ð°Ñ Ð¿Ñ€Ð¸ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…
    if (consecutiveFailCount >= 10 && (now - lastFailTime) < 3600000UL) {
        return false;
    }
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
    if (now - lastTsPublish < config.thingSpeakInterval) {
        return false;
    }

    return true;
}
```

### 3. Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð² main.cpp
```cpp
// Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
if (canSendToThingSpeak()) {
    const bool tsOk = sendDataToThingSpeak();
    if (tsOk) {
        thingspeakBatchTimer = currentTime;
        DEBUG_PRINTLN("[BATCH] ThingSpeak Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð¹");
    } else {
        DEBUG_PRINTLN("[BATCH] ThingSpeak Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ, Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ Ñ‡ÐµÑ€ÐµÐ· ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»");
    }
} else {
    DEBUG_PRINTLN("[BATCH] ThingSpeak Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð° (Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ/Ð¾ÑˆÐ¸Ð±ÐºÐ¸)");
}
```

## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

### Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚ÐµÑÑ‚: `test/test_thingspeak_rate_limiting.py`
- âœ… Ð¢ÐµÑÑ‚ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
- âœ… Ð¢ÐµÑÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
- âœ… Ð¢ÐµÑÑ‚ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…
- âœ… Ð¢ÐµÑÑ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…
- âœ… Ð¢ÐµÑÑ‚ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ð¾Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…
- âœ… Ð¢ÐµÑÑ‚ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð»Ð¸Ð¼Ð¸Ñ‚Ð° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
- âœ… Ð¢ÐµÑÑ‚ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸

**Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚**: Ð’ÑÐµ 7 Ñ‚ÐµÑÑ‚Ð¾Ð² Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!

## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹

### Ð”Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:
- âŒ Ð¡Ð¿Ð°Ð¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸ Ðº ThingSpeak
- âŒ ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð½Ð° 1 Ñ‡Ð°Ñ
- âŒ Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° Ð¾Ñ‚ ThingSpeak

### ÐŸÐ¾ÑÐ»Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:
- âœ… ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- âœ… ÐšÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°Ñ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° Ð½Ð° 1 Ñ‡Ð°Ñ Ð¿Ñ€Ð¸ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…
- âœ… ÐŸÑ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
- âœ… Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
- âœ… ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°

## ðŸ”§ Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸

### Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:
1. **`src/thingspeak_client.cpp`**:
   - Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ `lastFailTime`
   - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ `canSendToThingSpeak()`
   - Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð° Ð»Ð¾Ð³Ð¸ÐºÐ° `sendDataToThingSpeak()`

2. **`src/thingspeak_client.h`**:
   - Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð¿Ñ€Ð¾Ñ‚Ð¾Ñ‚Ð¸Ð¿ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ `canSendToThingSpeak()`

3. **`src/main.cpp`**:
   - Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð° Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð² ThingSpeak
   - Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°

4. **`test/test_thingspeak_rate_limiting.py`**:
   - ÐÐ¾Ð²Ñ‹Ð¹ Ñ‚ÐµÑÑ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð»Ð¾Ð³Ð¸ÐºÐ¸ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñ‹

### ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹:
- **Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» ThingSpeak**: 600000 Ð¼Ñ (10 Ð¼Ð¸Ð½ÑƒÑ‚)
- **ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…**: 3600000 Ð¼Ñ (1 Ñ‡Ð°Ñ)
- **Ð›Ð¸Ð¼Ð¸Ñ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº**: 10 Ð¿Ð¾Ð´Ñ€ÑÐ´

## ðŸŽ¯ Ð—Ð°ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ

ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸ÐµÐ¼ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº ThingSpeak Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ñ€ÐµÑˆÐµÐ½Ð°. Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ñ‚ÐµÐ¿ÐµÑ€ÑŒ:

1. **ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñƒ** Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼
2. **Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ Ð½Ð° 1 Ñ‡Ð°Ñ** Ð¿Ñ€Ð¸ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…
3. **Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ** Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
4. **ÐŸÑ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚** Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
5. **ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÑ‚** Ð²ÑÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ

Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾, ÐºÐ¾Ð´ ÑÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð»ÑÑ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº. 